<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SURVIVAL IO - FULL EDITION</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #1a1a1a; font-family: 'Arial Black', sans-serif; touch-action: none; }
        canvas { display: none; background: #2d2d2d; cursor: crosshair; }
        
        /* Menú Principal */
        #menu-inicial { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(26,26,26,0.9); color: white; z-index: 100; }
        .box { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; border: 2px solid #3498db; text-align: center; }
        .btn { background: #2ecc71; border: none; padding: 15px; color: white; font-size: 18px; cursor: pointer; border-radius: 8px; margin: 10px; width: 220px; border-bottom: 4px solid #27ae60; }
        input { padding: 10px; border-radius: 5px; border: none; width: 200px; margin-bottom: 10px; text-align: center; }

        /* UI de Juego */
        #ui-juego { position: absolute; top: 10px; left: 10px; color: white; display: none; pointer-events: none; z-index: 10; }
        .stats { background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; border: 1px solid #555; }
        #vida-bar { width: 150px; height: 10px; background: #444; border: 1px solid white; margin-top: 5px; }
        #vida-fill { width: 100%; height: 100%; background: #ff4444; }

        /* Controles Móviles */
        #touch-controls { position: absolute; bottom: 20px; width: 100%; display: none; height: 150px; pointer-events: none; }
        .joy-area { position: absolute; left: 30px; bottom: 20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; }
        .joy-stick { position: absolute; left: 30px; top: 30px; width: 40px; height: 40px; background: white; border-radius: 50%; opacity: 0.5; }
        #btn-shoot { position: absolute; right: 30px; bottom: 30px; width: 80px; height: 80px; background: rgba(231, 76, 60, 0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; pointer-events: auto; border: 3px solid #c0392b; }
    </style>
</head>
<body>

    <div id="menu-inicial">
        <div class="box">
            <h1 style="color: #3498db; margin-top:0;">ZOMBIE BATTLE IO</h1>
            <p>TU ID: <input type="text" id="mi-id" readonly style="background:none; color:gold; font-weight:bold;"></p>
            <input type="text" id="id-amigo" placeholder="ID de tu amigo">
            <br>
            <button class="btn" onclick="comenzar(false)">JUGAR SOLO / HOST</button>
            <button class="btn" style="background:#3498db; border-color:#2980b9;" onclick="comenzar(true)">UNIRSE A AMIGO</button>
        </div>
    </div>

    <div id="ui-juego">
        <div class="stats">
            ORO: $<span id="oro-txt">0</span>
            <div id="vida-bar"><div id="vida-fill"></div></div>
        </div>
    </div>

    <div id="touch-controls">
        <div class="joy-area" id="joy-area"><div class="joy-stick" id="joy-stick"></div></div>
        <div id="btn-shoot">FUEGO</div>
    </div>

    <canvas id="juego"></canvas>

    <script>
        const canvas = document.getElementById("juego");
        const ctx = canvas.getContext("2d");
        const MUNDO = 3000;
        
        let enJuego = false, jugador, zombies = [], balas = [], teclas = {}, camara = {x:0, y:0};
        let otrosJugadores = {}, conexiones = [], mouseX = 0, mouseY = 0;
        let joyPos = {x:0, y:0}, isTouching = false;

        // --- NETWORK MANAGER ---
        const peer = new Peer();
        peer.on('open', id => document.getElementById('mi-id').value = id);
        peer.on('connection', conn => {
            conexiones.push(conn);
            conn.on('data', data => {
                if(data.type === 'pos') otrosJugadores[conn.peer] = data;
                if(data.type === 'shoot') balas.push({x: data.x, y: data.y, vx: data.vx, vy: data.vy, remoto: true});
            });
        });

        function enviar(data) { conexiones.forEach(c => { if(c.open) c.send(data); }); }

        function comenzar(esInvitado) {
            if(esInvitado) {
                const idA = document.getElementById('id-amigo').value;
                if(!idA) return alert("Pega el ID de tu amigo");
                const conn = peer.connect(idA);
                conexiones.push(conn);
                conn.on('data', data => {
                    if(data.type === 'pos') otrosJugadores[conn.peer] = data;
                    if(data.type === 'shoot') balas.push({x: data.x, y: data.y, vx: data.vx, vy: data.vy, remoto: true});
                });
            }
            
            document.getElementById('menu-inicial').style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('ui-juego').style.display = 'block';
            if('ontouchstart' in window) document.getElementById('touch-controls').style.display = 'block';
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            jugador = { x: MUNDO/2, y: MUNDO/2, r: 25, vel: 5, vida: 100, oro: 0, ang: 0, lastS: 0 };
            for(let i=0; i<30; i++) spawnZombie();
            requestAnimationFrame(bucle);
        }

        // --- CONTROLES MÓVIL (JOYSTICK) ---
        const joyArea = document.getElementById("joy-area");
        const joyStick = document.getElementById("joy-stick");
        joyArea.addEventListener("touchmove", e => {
            let rect = joyArea.getBoundingClientRect();
            let touch = e.touches[0];
            let dx = touch.clientX - (rect.left + 50);
            let dy = touch.clientY - (rect.top + 50);
            let dist = Math.min(40, Math.hypot(dx, dy));
            let a = Math.atan2(dy, dx);
            joyPos = { x: Math.cos(a) * (dist/40), y: Math.sin(a) * (dist/40) };
            joyStick.style.transform = `translate(${Math.cos(a)*dist}px, ${Math.sin(a)*dist}px)`;
            isTouching = true;
        });
        joyArea.addEventListener("touchend", () => { isTouching = false; joyPos = {x:0, y:0}; joyStick.style.transform = "none"; });
        document.getElementById("btn-shoot").addEventListener("touchstart", e => { e.preventDefault(); disparar(); });

        // --- CONTROLES PC ---
        window.addEventListener("keydown", e => { teclas[e.key.toLowerCase()] = true; if(e.key === " ") disparar(); });
        window.addEventListener("keyup", e => teclas[e.key.toLowerCase()] = false);
        window.addEventListener("mousemove", e => {
            mouseX = e.clientX; mouseY = e.clientY;
            jugador.ang = Math.atan2((mouseY + camara.y) - jugador.y, (mouseX + camara.x) - jugador.x);
        });

        function disparar() {
            let ahora = Date.now();
            if(ahora - jugador.lastS > 250) {
                let vx = Math.cos(jugador.ang) * 15;
                let vy = Math.sin(jugador.ang) * 15;
                balas.push({ x: jugador.x, y: jugador.y, vx, vy });
                enviar({ type: 'shoot', x: jugador.x, y: jugador.y, vx, vy });
                jugador.lastS = ahora;
            }
        }

        function actualizar() {
            if(!enJuego) return;

            // Movimiento
            if(isTouching) {
                jugador.x += joyPos.x * jugador.vel;
                jugador.y += joyPos.y * jugador.vel;
                jugador.ang = Math.atan2(joyPos.y, joyPos.x);
            } else {
                if(teclas['w']) jugador.y -= jugador.vel;
                if(teclas['s']) jugador.y += jugador.vel;
                if(teclas['a']) jugador.x -= jugador.vel;
                if(teclas['d']) jugador.x += jugador.vel;
            }

            camara.x = jugador.x - canvas.width/2;
            camara.y = jugador.y - canvas.height/2;

            // Lógica Pro (Anti-Lag)
            balas = balas.filter(b => b.x > 0 && b.x < MUNDO && b.y > 0 && b.y < MUNDO);
            enviar({ type: 'pos', x: jugador.x, y: jugador.y, ang: jugador.ang });

            zombies.forEach((z, i) => {
                let d = Math.hypot(jugador.x - z.x, jugador.y - z.y);
                z.x += (jugador.x - z.x)/d * 2;
                z.y += (jugador.y - z.y)/d * 2;
                if(d < 45) {
                    jugador.vida -= 0.2;
                    document.getElementById('vida-fill').style.width = jugador.vida + "%";
                    if(jugador.vida <= 0) location.reload();
                }
            });

            balas.forEach((b, bi) => {
                b.x += b.vx; b.y += b.vy;
                zombies.forEach((z, zi) => {
                    if(Math.hypot(b.x - z.x, b.y - z.y) < 30) {
                        zombies.splice(zi, 1);
                        balas.splice(bi, 1);
                        jugador.oro += 10;
                        document.getElementById('oro-txt').innerText = jugador.oro;
                        spawnZombie();
                    }
                });
            });
        }

        function dibujar() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            ctx.save(); ctx.translate(-camara.x, -camara.y);

            // Suelo Grid
            ctx.strokeStyle = "#333";
            for(let i=0; i<MUNDO; i+=100) ctx.strokeRect(i, 0, 100, MUNDO);

            // Otros
            for(let id in otrosJugadores) {
                let o = otrosJugadores[id];
                ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(o.x, o.y, 25, 0, Math.PI*2); ctx.fill();
            }

            // Jugador
            ctx.save();
            ctx.translate(jugador.x, jugador.y);
            ctx.rotate(jugador.ang);
            ctx.fillStyle = "#000"; ctx.fillRect(15, -5, 30, 10); // Cañón
            ctx.restore();
            
            ctx.fillStyle = "#3498db"; ctx.strokeStyle = "#fff"; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.arc(jugador.x, jugador.y, 25, 0, Math.PI*2); ctx.fill(); ctx.stroke();

            // Zombies y Balas
            ctx.fillStyle = "#2ecc71"; zombies.forEach(z => { ctx.beginPath(); ctx.arc(z.x, z.y, 20, 0, Math.PI*2); ctx.fill(); });
            ctx.fillStyle = "yellow"; balas.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, Math.PI*2); ctx.fill(); });

            ctx.restore();
        }

        function spawnZombie() { zombies.push({x: Math.random()*MUNDO, y: Math.random()*MUNDO}); }
        function bucle() { actualizar(); dibujar(); requestAnimationFrame(bucle); }
    </script>
</body>
</html>
