<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ZOMBIES.IO - BATTLE STYLE</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #1a1a1a; font-family: 'Arial Black', sans-serif; }
        canvas { display: none; background: #333; cursor: crosshair; }
        
        #menu { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: white; background: radial-gradient(circle, #2c3e50 0%, #000 100%);
        }

        .btn {
            background: #f1c40f; border: none; padding: 12px; color: #333;
            font-weight: bold; font-size: 16px; cursor: pointer; border-radius: 5px; 
            margin: 5px; width: 260px; border-bottom: 4px solid #f39c12;
        }

        #ui-juego { position: absolute; top: 20px; left: 20px; color: white; display: none; pointer-events: none; width: 250px; }
        .hud-box { background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; border: 2px solid #555; }
        #vida-bg { width: 100%; height: 20px; background: #444; border-radius: 5px; margin: 10px 0; border: 1px solid #fff; }
        #vida-bar { width: 100%; height: 100%; background: #ff4757; transition: 0.2s; }
        .inv-slot { display: inline-block; width: 40px; height: 40px; border: 2px solid #777; margin-right: 5px; text-align: center; line-height: 40px; font-size: 12px; background: rgba(255,255,255,0.1); }
        .active-slot { border-color: #f1c40f; background: rgba(241, 196, 15, 0.2); }
    </style>
</head>
<body>

    <div id="menu">
        <h1 style="font-size: 45px; color: #f1c40f; text-shadow: 3px 3px #000;">ZOMBIES.IO</h1>
        <div style="background: rgba(0,0,0,0.6); padding: 25px; border-radius: 15px; border: 3px solid #3498db; text-align: center;">
            <h2 style="color: gold; margin-top: 0;">BANCO: $<span id="banco-total">0</span></h2>
            <button class="btn" onclick="empezarJuego()">SOBREVIVIR</button><br>
            <button class="btn" style="background: #e67e22; border-color: #d35400;" onclick="comprar('ak47', 150)">AK-47 ($150)</button><br>
            <button class="btn" style="background: #9b59b6; border-color: #8e44ad;" onclick="comprar('sniper', 300)">SNIPER ($300)</button><br>
            <button class="btn" style="background: #e74c3c; border-color: #c0392b;" onclick="comprar('shotgun', 200)">SHOTGUN ($200)</button>
        </div>
    </div>

    <div id="ui-juego">
        <div class="hud-box">
            <div style="font-size: 20px; color: gold;">ORO: $<span id="puntos">0</span></div>
            <div id="vida-bg"><div id="vida-bar"></div></div>
            <div id="inventario-visual">
                <div id="slot-1" class="inv-slot active-slot">1</div>
                <div id="slot-2" class="inv-slot">2</div>
                <div id="slot-3" class="inv-slot">3</div>
                <div id="slot-4" class="inv-slot">4</div>
            </div>
            <div id="arma-txt" style="margin-top: 10px; font-size: 12px; color: #aaa;">TECLAS 1-4 PARA CAMBIAR</div>
        </div>
    </div>

    <canvas id="juego"></canvas>

    <script>
        const canvas = document.getElementById("juego");
        const ctx = canvas.getContext("2d");
        const MUNDO = 3000;
        
        // Datos de persistencia
        let banco = parseInt(localStorage.getItem("banco_io")) || 0;
        let armasCompradas = JSON.parse(localStorage.getItem("mis_armas")) || ["pistola"];
        document.getElementById("banco-total").innerText = banco;

        const ARMAS_STATS = {
            pistola: { cadencia: 400, dmg: 25, velB: 15, color: "#95a5a6", largo: 25, slot: 1 },
            ak47: { cadencia: 120, dmg: 20, velB: 18, color: "#27ae60", largo: 38, slot: 2 },
            sniper: { cadencia: 1000, dmg: 120, velB: 35, color: "#2980b9", largo: 55, slot: 3 },
            shotgun: { cadencia: 800, dmg: 15, velB: 12, color: "#d35400", largo: 32, slot: 4 }
        };

        let enJuego = false, jugador, zombies = [], balas = [], teclas = {}, mouseX = 0, mouseY = 0, camara = {x:0, y:0};
        let lastShot = 0;

        function empezarJuego() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            enJuego = true;
            document.getElementById("menu").style.display = "none";
            canvas.style.display = "block";
            document.getElementById("ui-juego").style.display = "block";

            jugador = { 
                x: MUNDO/2, y: MUNDO/2, r: 25, vida: 100, puntos: 0, 
                vel: 5, arma: "pistola", inv: armasCompradas 
            };

            for(let i=0; i<30; i++) spawnZombie();
            requestAnimationFrame(bucle);
        }

        function spawnZombie() {
            zombies.push({ x: Math.random()*MUNDO, y: Math.random()*MUNDO, r: 24, vel: 2 + Math.random() });
        }

        window.addEventListener("keydown", (e) => {
            teclas[e.key.toLowerCase()] = true;
            // Cambio de arma con números
            if (["1","2","3","4"].includes(e.key)) {
                let armaElegida = Object.keys(ARMAS_STATS).find(k => ARMAS_STATS[k].slot == e.key);
                if (jugador.inv.includes(armaElegida)) {
                    jugador.arma = armaElegida;
                    actualizarUIInventario(e.key);
                }
            }
        });
        window.addEventListener("keyup", (e) => teclas[e.key.toLowerCase()] = false);
        window.addEventListener("mousemove", (e) => { mouseX = e.clientX; mouseY = e.clientY; });

        function actualizarUIInventario(slot) {
            for(let i=1; i<=4; i++) document.getElementById("slot-"+i).className = "inv-slot";
            document.getElementById("slot-"+slot).className = "inv-slot active-slot";
        }

        function actualizar() {
            // Movimiento
            if (teclas["w"] && jugador.y > 0) jugador.y -= jugador.vel;
            if (teclas["s"] && jugador.y < MUNDO) jugador.y += jugador.vel;
            if (teclas["a"] && jugador.x > 0) jugador.x -= jugador.vel;
            if (teclas["d"] && jugador.x < MUNDO) jugador.x += jugador.vel;

            camara.x = jugador.x - canvas.width/2;
            camara.y = jugador.y - canvas.height/2;

            // Zombies con Colisión Física (Para que no te atraviesen)
            zombies.forEach(z => {
                let dx = jugador.x - z.x;
                let dy = jugador.y - z.y;
                let dist = Math.hypot(dx, dy);

                if (dist > 5) {
                    z.x += (dx/dist) * z.vel;
                    z.y += (dy/dist) * z.vel;
                }

                // Lógica de colisión sólida (No atravesar)
                if (dist < jugador.r + z.r) {
                    let overlap = (jugador.r + z.r) - dist;
                    z.x -= (dx/dist) * overlap; // Empuja al zombie hacia atrás
                    z.y -= (dy/dist) * overlap;
                    jugador.vida -= 0.4;
                    document.getElementById("vida-bar").style.width = jugador.vida + "%";
                    if(jugador.vida <= 0) morir();
                }
            });

            // Disparo
            if (teclas["mousedown"] || teclas[" "]) disparar(); 

            // Balas
            balas.forEach((b, bi) => {
                b.x += b.vx; b.y += b.vy;
                zombies.forEach((z, zi) => {
                    if (Math.hypot(b.x - z.x, b.y - z.y) < z.r) {
                        jugador.puntos += 10;
                        document.getElementById("puntos").innerText = jugador.puntos;
                        zombies.splice(zi, 1);
                        if(b.tipo !== "sniper") balas.splice(bi, 1);
                        spawnZombie();
                    }
                });
            });
        }

        function disparar() {
            let ahora = Date.now();
            let s = ARMAS_STATS[jugador.arma];
            if (ahora - lastShot > s.cadencia) {
                let ang = Math.atan2((mouseY + camara.y) - jugador.y, (mouseX + camara.x) - jugador.x);
                if(jugador.arma === "shotgun") {
                    for(let i=-2; i<=2; i++) balas.push({x: jugador.x, y: jugador.y, vx: Math.cos(ang+i*0.15)*s.velB, vy: Math.sin(ang+i*0.15)*s.velB, tipo: "shotgun"});
                } else {
                    balas.push({x: jugador.x, y: jugador.y, vx: Math.cos(ang)*s.velB, vy: Math.sin(ang)*s.velB, tipo: jugador.arma});
                }
                lastShot = ahora;
            }
        }
        window.addEventListener("mousedown", () => teclas["mousedown"] = true);
        window.addEventListener("mouseup", () => teclas["mousedown"] = false);

        function dibujar() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-camara.x, -camara.y);

            // Suelo Grid
            ctx.fillStyle = "#333"; ctx.fillRect(0,0, MUNDO, MUNDO);
            ctx.strokeStyle = "#444";
            for(let i=0; i<MUNDO; i+=100) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,MUNDO); ctx.stroke(); }
            for(let j=0; j<MUNDO; j+=100) { ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(MUNDO,j); ctx.stroke(); }

            // Zombies
            zombies.forEach(z => {
                ctx.fillStyle = "#ff4d4d"; ctx.strokeStyle = "#000"; ctx.lineWidth = 4;
                ctx.beginPath(); ctx.arc(z.x, z.y, z.r, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            });

            // Arma
            let ang = Math.atan2((mouseY + camara.y) - jugador.y, (mouseX + camara.x) - jugador.x);
            ctx.save();
            ctx.translate(jugador.x, jugador.y);
            ctx.rotate(ang);
            ctx.fillStyle = ARMAS_STATS[jugador.arma].color; ctx.strokeStyle = "#000"; ctx.lineWidth = 3;
            ctx.fillRect(15, -6, ARMAS_STATS[jugador.arma].largo, 12);
            ctx.strokeRect(15, -6, ARMAS_STATS[jugador.arma].largo, 12);
            ctx.restore();

            // Jugador (Taming.io Style)
            ctx.fillStyle = "#3498db"; ctx.strokeStyle = "#000"; ctx.lineWidth = 5;
            ctx.beginPath(); ctx.arc(jugador.x, jugador.y, jugador.r, 0, Math.PI*2); ctx.fill(); ctx.stroke();

            // Balas
            balas.forEach(b => {
                ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, Math.PI*2); ctx.fill();
            });

            ctx.restore();
        }

        function comprar(arma, precio) {
            if(banco >= precio && !armasCompradas.includes(arma)) {
                banco -= precio;
                armasCompradas.push(arma);
                localStorage.setItem("banco_io", banco);
                localStorage.setItem("mis_armas", JSON.stringify(armasCompradas));
                document.getElementById("banco-total").innerText = banco;
                alert("¡" + arma.toUpperCase() + " DESBLOQUEADA! USA LOS NÚMEROS EN EL JUEGO.");
            } else if (armasCompradas.includes(arma)) {
                alert("YA TIENES ESTA ARMA");
            } else { alert("ORO INSUFICIENTE"); }
        }

        function morir() {
            enJuego = false;
            banco += jugador.puntos;
            localStorage.setItem("banco_io", banco);
            alert("TE ELIMINARON. ORO TOTAL: " + banco);
            location.reload();
        }

        function bucle() { if(enJuego) { actualizar(); dibujar(); requestAnimationFrame(bucle); } }
    </script>
</body>
</html>
